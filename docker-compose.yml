services:
  uhf-server:
    # Use pre-built image from GitHub Container Registry
    image: ${IMAGE_REGISTRY:-ghcr.io/rydizz214/uhf-server-docker}:${IMAGE_TAG:-1.5.1}

    # Optional: if image not found locally, pull from registry
    pull_policy: ${PULL_POLICY:-missing}

    container_name: uhf-server
    restart: unless-stopped

    # Privileged mode required for systemd-inhibit and dbus integration
    privileged: true

    # Load environment variables from .env file
    env_file:
      - .env

    # Port mapping: host:container
    ports:
      - "${HOST_PORT:-8000}:${UHF_PORT:-8000}"

    # Volume mounts
    volumes:
      - "${HOST_RECORDINGS_DIR}:/recordings"
      - "${HOST_UHF_DATA_DIR}:/var/lib/uhf-server"
      # Required for systemd-inhibit and dbus integration
      - "/run/dbus/system_bus_socket:/run/dbus/system_bus_socket:ro"

    # Environment overrides
    environment:
      # Personal settings override defaults in the image
      TZ: ${TZ:-America/New_York}
      UHF_PORT: ${UHF_PORT:-8000}
      UHF_RECORDINGS_DIR: ${UHF_RECORDINGS_DIR:-/recordings}
      UHF_DATA_DIR: ${UHF_DATA_DIR:-/var/lib/uhf-server}
      UHF_ENABLE_COMMERCIAL_DETECTION: ${UHF_ENABLE_COMMERCIAL_DETECTION:-true}
      COMSKIP_ARGS: ${COMSKIP_ARGS:---ini}
      LOG_LEVEL: ${LOG_LEVEL:-info}

    # Healthcheck: verify UHF Server is responding
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${UHF_PORT:-8000}/server/stats"]
      interval: 60s
      timeout: 10s
      start_period: 10s
      retries: 3
